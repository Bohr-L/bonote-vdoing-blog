---
title:  存储过程和触发器的作用
date: 2025-12-29 11:33:34
permalink: /pages/7a79fa/
categories:
  - 常见面试题
  - MySQL 类
tags:
  - 
---
#### 1. 存储过程（Stored Procedure）

- **定义**：存储在数据库中的 “预编译 SQL 语句集合”，可包含条件判断、循环、变量等逻辑，通过调用名称执行，无需重复编写 SQL；

- **核心作用**：

    - 简化复杂业务逻辑：将多步 SQL（如查询 + 修改 + 插入）封装为存储过程，应用层直接调用（如`CALL add_order(1, '商品A')`），减少应用层与数据库的交互次数；
    - 提高性能：存储过程预编译后存储在数据库中，调用时无需再次解析、优化，比单次执行多条 SQL 更快；
    - 增强安全性：通过存储过程执行数据操作，可限制应用层直接访问表，只授予存储过程的调用权限，避免误操作或恶意修改；
    - 代码复用：多个应用（如 Web 端、APP 端）可调用同一存储过程，避免重复编写 SQL 逻辑；

- **语法示例**：
  ```sql
  -- 创建存储过程：添加订单并扣减库存
  DELIMITER // -- 修改结束符（默认;，避免与存储过程内;冲突）
  CREATE PROCEDURE add_order(IN user_id INT, IN goods_id INT, IN num INT)
  BEGIN
      -- 插入订单
      INSERT INTO `order` (user_id, goods_id, num) VALUES (user_id, goods_id, num);
      -- 扣减库存
      UPDATE goods SET stock = stock - num WHERE id = goods_id;
  END //
  DELIMITER ; -- 恢复结束符
  
  -- 调用存储过程
  CALL add_order(1, 2001, 2);
  ```



- **优缺点**：

    - 优点：简化逻辑、提高性能、增强安全、代码复用；
    - 缺点：调试困难（需用专门工具）、移植性差（不同数据库的存储过程语法差异大）、占用数据库资源。

#### 2. 触发器（Trigger）

- **定义**：绑定在表上的 “自动执行的 SQL 逻辑”，当表发生特定事件（INSERT/UPDATE/DELETE）时，触发器自动触发执行，无需手动调用；

- **核心作用**：

    - 保证数据一致性：如订单表插入数据时，自动扣减商品表库存（替代应用层逻辑，避免漏扣）；
    - 记录数据变更日志：如用户表数据修改时，自动插入日志表（记录修改前、修改后的值、修改时间、操作用户）；
    - 数据校验：如插入用户数据时，校验手机号格式是否正确，不正确则拒绝插入；
    - 级联操作：如删除用户时，自动删除该用户的所有订单（替代外键的 ON DELETE CASCADE，更灵活）；

- **语法示例**：
  ```sql
  -- 创建触发器：插入订单时，自动扣减商品库存
  DELIMITER //
  CREATE TRIGGER trigger_order_after_insert
  AFTER INSERT ON `order` -- 订单表插入后触发
  FOR EACH ROW -- 行级触发器（每插入一行触发一次）
  BEGIN
      UPDATE goods SET stock = stock - NEW.num WHERE id = NEW.goods_id; -- NEW表示插入的新行数据
  END //
  DELIMITER ;
  
  -- 插入订单，触发器自动执行
  INSERT INTO `order` (user_id, goods_id, num) VALUES (1, 2001, 2);
  ```



- **触发器的关键要素**：

    - 触发时机：AFTER（事件后触发）、BEFORE（事件前触发）；
    - 触发事件：INSERT、UPDATE、DELETE；
    - 触发级别：行级触发器（FOR EACH ROW，每一行触发）、语句级触发器（FOR EACH STATEMENT，整个语句触发一次）；
    - 特殊变量：NEW（INSERT/UPDATE 后的新数据）、OLD（UPDATE/DELETE 前的旧数据）；

- **优缺点**：

    - 优点：自动执行、保证数据一致性、简化应用层逻辑；
    - 缺点：隐式执行（不易排查问题）、可能影响性能（复杂触发器会拖慢表操作）、移植性差。

#### 3. 存储过程与触发器的区别

| 对比维度 | 存储过程                                 | 触发器                             |
| -------- | ---------------------------------------- | ---------------------------------- |
| 执行方式 | 手动调用（CALL 语句）                    | 自动触发（表事件触发）             |
| 触发条件 | 无（需显式调用）                         | 表的 INSERT/UPDATE/DELETE 事件     |
| 适用场景 | 复杂业务逻辑（多表操作、循环、条件判断） | 数据一致性保障、日志记录、数据校验 |
| 灵活性   | 高（支持参数、返回值、复杂逻辑）         | 低（仅能绑定表事件，逻辑简单）     |